<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - views/consult-edit-view.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome-ie7.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>views/consult-edit-view.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">71.71</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">297</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">29.14</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.55</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/*global window, Backbone, $, i18n*/
(function(NS) {
    &quot;use strict&quot;;
    //Filename: views/detail-consult-view.js
    NS = NS || {};
    var isInBrowser = typeof module === &#039;undefined&#039; &amp;&amp; typeof window !== &#039;undefined&#039;;
    //var NotImplementedException = isInBrowser ? NS.Helpers.Exceptions.NotImplementedException : require(&#039;../helpers/custom_exception&#039;).NotImplementedException;
    var ErrorHelper = isInBrowser ? NS.Helpers.errorHelper : require(&#039;../helpers/error_helper&#039;);
    var CoreView = isInBrowser ? NS.Views.CoreView : require(&#039;./core-view&#039;);
    var form_helper = isInBrowser ? NS.Helpers.formHelper : require(&#039;../helpers/form_helper&#039;);
    var urlHelper = isInBrowser ? NS.Helpers.urlHelper : require(&#039;../helpers/url_helper&#039;);
    var utilHelper = isInBrowser ? NS.Helpers.utilHelper : require(&#039;../helpers/utilHelper&#039;);
    var ModelValidator = isInBrowser ? NS.Helpers.modelValidationPromise : require(&#039;../helpers/modelValidationPromise&#039;);
    var errorHelper = isInBrowser ? NS.Helpers.errorHelper : require(&#039;../helpers/error_helper&#039;);
    //Backbone view which can be use in order to create consultation view and edition view.
    var ConsultEditView = CoreView.extend({

        //The default tag for this view is a div.
        tagName: &#039;div&#039;,

        //The default class for this view.
        className: &#039;consultEditView&#039;,

        //Service to get the model.
        getModelSvc: undefined,

        //Service to delete the model.
        deleteModelSvc: undefined,

        //Service to save a model wether it is a model or a collection.
        saveModelSvc: undefined,

        //Template for the edit mode.
        templateEdit: undefined,

        //Template for the consultation mode.
        templateConsult: undefined,


        //Default options for the view.
        defaultOptions: {
            isModelToLoad: true, //By default the model is loaded.
            isEditMode: true,
            isNavigationOnSave: true,
            isNavigationOnDelete: true,
            isSaveOnServer: true,
            collectionSelector: &quot;tbody tr&quot;
        },

        //Initialize function
        initialize: function initializeConsultEdit(options) {
            options = options || {};
            CoreView.prototype.initialize.call(this, options);
            //By default the view is in consultationmode and if edit mode is active and isEdit has been activated in th options. 
            this.isEdit = (this.opts.isEditMode &amp;&amp; this.opts.isEdit) || false;
            if (this.model) {
                //render view when the model is loaded
                this.model.on(&#039;change&#039;, this.render, this);
            }
            // In order to be loaded a model has to have an id and the options must be activated.
            if (this.opts.isModelToLoad &amp;&amp; typeof this.model.has === &quot;function&quot; &amp;&amp; this.model.has(&#039;id&#039;)) {
                //Try to load the model from a service which have to return a promise.
                var view = this;
                this.getModelSvc(this.model.get(&#039;id&#039;))
                    .then(function success(jsonModel) {
                        view.model.set(jsonModel);
                    }).then(null, function error(errorResponse) {
                        ErrorHelper.manageResponseErrors(errorResponse, {
                            model: this.model
                        });
                    });
            }
        },

        //Events handle by the view with user interaction
        events: {
            &quot;click button.btnEdit&quot;: &quot;edit&quot;,
            &quot;click button.btnDelete&quot;: &quot;deleteItem&quot;,
            &quot;click .panel-heading&quot;: &quot;toogleCollapse&quot;,
            &quot;click button[type=&#039;submit&#039;]&quot;: &quot;save&quot;,
            &quot;click button.btnCancel&quot;: &quot;cancelEdition&quot;
        },

        //JSON data to attach to the template.
        getRenderData: function getRenderDataConsultEdit() {
            return this.model.toJSON();
        },

        //genarate navigation url usefull if the edit mode is not on the same page.
        generateEditUrl: function generateEditUrl() {
            return this.model.modelName + &quot;/edit/&quot; + this.model.get(&#039;id&#039;);
        },

        //Change the edit mode.
        toggleEditMode: function toogleEditMode(event) {
            if (event) {
                event.preventDefault();
            }
            this.isEdit = !this.isEdit;
            this.render({
                isSearchTriggered: true
            }); //todo: fix this to have no options.
        },

        //Deal with the edit button click wether there is an edit mode or not.
        edit: function editConsultEditView(event) {
            event.preventDefault();
            if (this.opts.isEditMode) {
                this.toggleEditMode();
            } else {
                Backbone.history.navigate(this.generateEditUrl(), true);
            }
        },
        //Get the json data to be save by the view.
        getDataToSave: function getDataToSaveDetailEdit() {
            return this.model.toJSON();
        },
        //Deal with the save event on the page.
        save: function saveConsultEdit(event) {
            event.preventDefault();
            //Call a different method depending on the fact that the model is a collection or a model.
            if (utilHelper.isBackboneModel(this.model)) {
                this.saveModel();
            } else if (utilHelper.isBackboneCollection(this.model)) {
                this.saveCollection();
            }

        },
        //Save a backbone collection.
        saveCollection: function saveBackboneCollection() {
            //Call the form helper in order to rebuild the collection from the form.
            form_helper.formCollectionBinder(
                $(this.opts.collectionSelector, this.$el),
                this.model
            );
            //Bind the this to the current view for the
            var currentView = this;
            ModelValidator.validateAll(currentView.model)
                .then(function successValidation() {
                    //When the model is valid, unset errors.
                    currentView.model.forEach(function(mdl) {
                        mdl.unsetErrors();
                    }, currentView);
                    if (currentView.opts.isSaveOnServer) {
                        //Call the service in order to save the model.                   
                        currentView.saveModelSvc(currentView.getDataToSave())
                            .then(function success(jsonModel) {
                                currentView.saveSuccess(jsonModel); //.bind(currentView);
                            }, function error(responseError) {
                                currentView.saveError(responseError); //.bind(currentView);
                            });
                    } else {
                        currentView.saveSuccess(currentView.model.toJSON());
                    }

                }, function errorValidation(errors) {
                    //todo: see how to set errors.
                    errorHelper.setCollectionErrors(currentView.model, errors);
                    currentView.resetSaveButton();
                });
        },
        resetSaveButton: function resetSaveButton() {
            $(&#039;button[type=&quot;submit&quot;]&#039;, this.$el).button(&#039;reset&#039;);
        },
        //Save method in case of a model.
        saveModel: function saveBackboneModel() {
            //Call the form helper in order to rebuild the model from the form.
            form_helper.formModelBinder({
                inputs: $(&#039;input&#039;, this.$el),
                options: $(&#039;select&#039;, this.$el)
            }, this.model);

            //Bind the this to the current view for the
            var currentView = this;
            //Todo: Add a method in util in order to know if an object is a collectio or a model.
            //Add it into the initialize too.
            ModelValidator.validate(currentView.model)
                .then(function successValidation() {
                    //When the model is valid, unset errors.
                    currentView.model.unsetErrors();
                    if (currentView.opts.isSaveOnServer) {
                        //Call the service in order to save the model.                   
                        currentView.saveModelSvc(currentView.getDataToSave())
                            .then(function success(jsonModel) {
                                currentView.saveSuccess(jsonModel); //.bind(currentView);
                            }, function error(responseError) {
                                currentView.saveError(responseError); //.bind(currentView);
                            });
                    } else {
                        currentView.saveSuccess(currentView.model.toJSON());
                    }

                }, function errorValidation(errors) {
                    currentView.model.setErrors(errors);
                });
        },

        //Actions on save error
        saveError: function saveErrorConsultEdit(errors) {
            ErrorHelper.manageResponseErrors(errors, {
                model: this.model
            });
        },
        //Actions on save success.
        saveSuccess: function saveSuccessConsultEdit(jsonModel) {
            Backbone.Notification.addNotification({
                type: &#039;success&#039;,
                message: i18n.t(&#039;save.&#039; + (jsonModel.id ? &#039;create&#039; : &#039;update&#039;) + &#039;success&#039;)
            });
            // If the navigation on save is activated, navigate to the page.
            if (this.opts.isNavigationOnSave) {
                Backbone.history.navigate(this.generateNavigationUrl(), true);
            } else {
                // If there is no navigation on save, trigger a change event.
                this.model[utilHelper.isBackboneModel(this.model) ? &#039;set&#039; : &#039;reset&#039;](jsonModel, {
                    silent: true
                });
                this.toggleEditMode();
            }
        },

        generateNavigationUrl: function generateNavigationUrl() {
            if (this.model.get(&#039;id&#039;) === null || this.model.get(&#039;id&#039;) === undefined) {
                return &quot;/&quot;;
            }
            return urlHelper.generateUrl([this.model.modelName, this.model.get(&quot;id&quot;)], {});
        },

        //Code to delete an item.
        deleteItem: function deleteConsult(event) {
            event.preventDefault();
            var view = this;
            //call delete service
            this.deleteModelSvc()
                .then(function success(successResponse) {
                    view.deleteSuccess(successResponse);
                }, function error(errorResponse) {
                    view.deleteError(errorResponse);
                });
        },

        //Generate delete navigation url.
        generateDeleteUrl: function generateDeleteUrl() {
            return &quot;/&quot;;
        },

        // Actions after a delete success.
        deleteSuccess: function deleteConsultEditSuccess(response) {
            //remove the view from the DOM
            this.remove();
            if (this.opts.isNavigationOnDelete) {
                //navigate to next page
                Backbone.history.navigate(this.generateDeleteUrl(), true);
            }

        },

        // Actions after a delete error. 
        deleteError: function deleteConsultEditError(errorResponse) {
            ErrorHelper.manageResponseErrors(errorResponse, {
                isDisplay: true
            });
        },
        //Render function.
        render: function renderConsultEditView() {
            //todo: see if a getRenderData different from each mode is necessary or it coul be deal inside the getRenderDatatFunction if needed.
            var templateName = this.isEdit ? &#039;templateEdit&#039; : &#039;templateConsult&#039;;
            if (this.opts.isElementRedefinition) {
                this.setElement(this[templateName](this.getRenderData()));
            } else {
                this.$el.html(this[templateName](this.getRenderData()));
            }

            //if (this.isEdit) {
            //    this.$el.html(this.templateEdit(this.getRenderData()));
            //} else {
            //    this.$el.html(this.templateConsult(this.getRenderData()));
            //}

            return this;
        },

        //Function which is called after the render, usally necessary for jQuery plugins.
        afterRender: function postRenderDetailView() {
            CoreView.prototype.afterRender.call(this);
            $(&#039;.collapse&#039;, this.$el).collapse(&#039;show&#039;);
        }
    });


    // Differenciating export for node or browser.
    if (isInBrowser) {
        NS.Views = NS.Views || {};
        NS.Views.ConsultEditView = ConsultEditView;
    } else {
        module.exports = ConsultEditView;
    }
})(typeof module === &#039;undefined&#039; &amp;&amp; typeof window !== &#039;undefined&#039; ? window.Fmk : module.exports);</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
